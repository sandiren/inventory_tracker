{% extends "base.html" %}

{% block title %}Map View - Inventory Tracker{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+vx6kGPR/HIcPp3dGVi8nrpGL2N1Yw9A4JHFKZ3h0=" crossorigin="" />
  <style>
    #inventory-map {
      height: 70vh;
      min-height: 420px;
      width: 100%;
      border-radius: 0.75rem;
      overflow: hidden;
    }

    .leaflet-control-attribution,
    .leaflet-control-scale-line {
      font-size: 0.75rem;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Inventory Map</h1>
    <a class="btn btn-outline-primary" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
  </div>
  <div id="inventory-map" class="rounded shadow-sm"></div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-DvN1M36zrHfX5Yucs5cjoxOYD65Zj50sC1LFp6Z3A6A=" crossorigin=""></script>
  <script>
    const map = L.map('inventory-map', {
      zoomControl: true,
    }).setView([20, 0], 2);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20,
    }).addTo(map);

    L.control.scale({
      imperial: false,
    }).addTo(map);

    const items = {{ items_data|tojson }};
    const markers = [];

    items.forEach(item => {
      if (item.gps_lat !== null && item.gps_lng !== null) {
        const marker = L.marker([item.gps_lat, item.gps_lng], {
          title: item.name,
        }).addTo(map);
        marker.bindPopup(`
          <strong>${item.name}</strong><br>
          Status: ${item.status.replace('_', ' ')}<br>
          Location: ${item.location || 'â€”'}<br>
          <a href="${'{{ url_for('inventory_detail', item_id=0) }}'.replace('0', item.id)}">View Item</a>
        `);
        markers.push(marker);
      }
    });

    if (markers.length) {
      const group = new L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.2));
    } else {
      map.setView([20, 0], 2);
    }
  </script>
{% endblock %}
