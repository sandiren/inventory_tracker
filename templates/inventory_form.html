{% extends "base.html" %}

{% block title %}{{ action }} Inventory Item - Inventory Tracker{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-sA+vx6kGPR/HIcPp3dGVi8nrpGL21Yw9A4JHFKZ3h0=" crossorigin="" />
  <style>
    #location-map { height: 320px; }
  </style>
{% endblock %}

{% block content %}
  <h1 class="mb-4">{{ action }} Inventory Item</h1>
  <form method="post" class="row g-3">
    <div class="col-md-6">
      <label class="form-label" for="name">Name *</label>
      <input class="form-control" id="name" name="name" required value="{{ item.name if item else '' }}">
    </div>
    <div class="col-md-6">
      <label class="form-label" for="category">Category</label>
      <input class="form-control" id="category" name="category" value="{{ item.category if item else '' }}">
    </div>
    <div class="col-md-3">
      <label class="form-label" for="quantity">Quantity</label>
      <input class="form-control" id="quantity" name="quantity" type="number" min="0" value="{{ item.quantity if item else 1 }}">
    </div>
    <div class="col-md-9">
      <label class="form-label" for="location">Location</label>
      <input class="form-control" id="location" name="location" value="{{ item.location if item else '' }}">
    </div>
    <div class="col-12">
      <label class="form-label" for="description">Description</label>
      <textarea class="form-control" id="description" name="description" rows="3">{{ item.description if item else '' }}</textarea>
    </div>
    <div class="col-12">
      <label class="form-label" for="location-map">Map Location</label>
      <div id="location-map" class="rounded border"></div>
      <div class="d-flex flex-wrap gap-2 mt-2">
        <button class="btn btn-outline-primary btn-sm" id="use-my-location" type="button">
          Use My Current Location
        </button>
        <small class="text-muted">Click the map to set coordinates or use the button to fill in your current GPS position.</small>
      </div>
    </div>
    <div class="col-md-6">
      <label class="form-label" for="gps_lat">GPS Latitude</label>
      <input class="form-control" id="gps_lat" name="gps_lat" value="{{ item.gps_lat if item and item.gps_lat is not none else '' }}" readonly>
    </div>
    <div class="col-md-6">
      <label class="form-label" for="gps_lng">GPS Longitude</label>
      <input class="form-control" id="gps_lng" name="gps_lng" value="{{ item.gps_lng if item and item.gps_lng is not none else '' }}" readonly>
    </div>
    <div class="col-md-6">
      <label class="form-label" for="maintenance_due">Next Maintenance (YYYY-MM-DD)</label>
      <input class="form-control" id="maintenance_due" name="maintenance_due" type="date" value="{{ item.maintenance_due.strftime('%Y-%m-%d') if item and item.maintenance_due else '' }}">
    </div>
    <div class="col-12">
      <label class="form-label" for="maintenance_notes">Maintenance Notes</label>
      <textarea class="form-control" id="maintenance_notes" name="maintenance_notes" rows="3">{{ item.maintenance_notes if item else '' }}</textarea>
    </div>
    <div class="col-12 d-flex justify-content-between">
      <a class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}">Cancel</a>
      <button class="btn btn-primary" type="submit">{{ action }}</button>
    </div>
  </form>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-DvN1M36zrHfX5Yucs5cjoxOYD65Zj50sC1LFp6Z3A6A=" crossorigin=""></script>
  <script>
    (function() {
      const latInput = document.getElementById('gps_lat');
      const lngInput = document.getElementById('gps_lng');
      const defaultLat = latInput.value ? parseFloat(latInput.value) : null;
      const defaultLng = lngInput.value ? parseFloat(lngInput.value) : null;

      const hasDefaultCoords = defaultLat !== null && !Number.isNaN(defaultLat) &&
        defaultLng !== null && !Number.isNaN(defaultLng);

      const map = L.map('location-map', {
        center: hasDefaultCoords ? [defaultLat, defaultLng] : [20, 0],
        zoom: hasDefaultCoords ? 13 : 2,
        zoomControl: true
      });
      let marker = null;

      function setMarker(lat, lng) {
        if (Number.isNaN(lat) || Number.isNaN(lng)) {
          return;
        }

        const formattedLat = lat.toFixed(6);
        const formattedLng = lng.toFixed(6);

        latInput.value = formattedLat;
        lngInput.value = formattedLng;

        if (marker) {
          marker.setLatLng([lat, lng]);
        } else {
          marker = L.marker([lat, lng], { draggable: true }).addTo(map);
          marker.on('dragend', (event) => {
            const coords = event.target.getLatLng();
            setMarker(coords.lat, coords.lng);
          });
        }
      }

      if (hasDefaultCoords) {
        setMarker(defaultLat, defaultLng);
      }

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
      }).addTo(map);

      requestAnimationFrame(() => {
        map.invalidateSize();
      });

      map.on('click', function(event) {
        setMarker(event.latlng.lat, event.latlng.lng);
      });

      document.getElementById('use-my-location').addEventListener('click', function() {
        if (!navigator.geolocation) {
          alert('Geolocation is not supported by your browser.');
          return;
        }

        navigator.geolocation.getCurrentPosition(function(position) {
          const { latitude, longitude } = position.coords;
          map.setView([latitude, longitude], 15);
          setMarker(latitude, longitude);
        }, function() {
          alert('Unable to retrieve your location. Please allow location access or select on the map.');
        });
      });
    })();
  </script>
{% endblock %}
